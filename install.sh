#!/bin/bash

#=============================================================================
# Script: install.sh
# Descri√ß√£o: Script de instala√ß√£o e configura√ß√£o autom√°tica da cole√ß√£o
# Autor: Andre Berger
# Data: $(date '+%d/%m/%Y')
# Vers√£o: 1.0
# Licen√ßa: MIT
#=============================================================================

# Configura√ß√µes do script
set -e  # Sair se qualquer comando falhar
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LOG_FILE="/tmp/shell-scripts-install-$(date '+%Y%m%d_%H%M%S').log"

# Cores para output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly NC='\033[0m' # No Color

#=============================================================================
# FUN√á√ïES AUXILIARES
#=============================================================================

# Fun√ß√£o para imprimir mensagens coloridas
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ${message}" >> "$LOG_FILE"
}

# Fun√ß√£o para imprimir cabe√ßalho
print_header() {
    clear
    echo -e "${PURPLE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                     üêö SHELL BASH SCRIPTS COLLECTION                        ‚ïë"
    echo "‚ïë                          Instalador Autom√°tico                              ‚ïë"
    echo "‚ïë                              Vers√£o 1.0                                     ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    echo
}

# Fun√ß√£o para verificar sistema operacional
detect_os() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS=$NAME
        VERSION=$VERSION_ID
    elif type lsb_release >/dev/null 2>&1; then
        OS=$(lsb_release -si)
        VERSION=$(lsb_release -sr)
    else
        OS=$(uname -s)
        VERSION=$(uname -r)
    fi
    
    print_message "$CYAN" "üñ•Ô∏è  Sistema detectado: $OS $VERSION"
}

# Fun√ß√£o para verificar depend√™ncias
check_dependencies() {
    print_message "$BLUE" "üîç Verificando depend√™ncias..."
    
    local missing_deps=()
    local deps=("curl" "wget" "git" "bc" "awk" "sed" "grep")
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing_deps+=("$dep")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        print_message "$YELLOW" "‚ö†Ô∏è  Depend√™ncias faltando: ${missing_deps[*]}"
        install_dependencies "${missing_deps[@]}"
    else
        print_message "$GREEN" "‚úÖ Todas as depend√™ncias est√£o instaladas"
    fi
}

# Fun√ß√£o para instalar depend√™ncias
install_dependencies() {
    local deps=("$@")
    print_message "$BLUE" "üì¶ Instalando depend√™ncias: ${deps[*]}"
    
    if command -v apt &> /dev/null; then
        sudo apt update && sudo apt install -y "${deps[@]}"
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y "${deps[@]}"
    elif command -v yum &> /dev/null; then
        sudo yum install -y "${deps[@]}"
    elif command -v zypper &> /dev/null; then
        sudo zypper install -y "${deps[@]}"
    elif command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm "${deps[@]}"
    else
        print_message "$RED" "‚ùå Gerenciador de pacotes n√£o suportado!"
        print_message "$YELLOW" "‚ö†Ô∏è  Instale manualmente: ${deps[*]}"
        read -p "Pressione ENTER para continuar..."
    fi
}

# Fun√ß√£o para configurar permiss√µes
setup_permissions() {
    print_message "$BLUE" "üîê Configurando permiss√µes de execu√ß√£o..."
    
    local script_count=0
    while IFS= read -r -d '' script; do
        if [[ -f "$script" && "$script" == *.sh ]]; then
            chmod +x "$script"
            ((script_count++))
        fi
    done < <(find "$SCRIPT_DIR" -name "*.sh" -print0)
    
    print_message "$GREEN" "‚úÖ Configuradas permiss√µes para $script_count scripts"
}

# Fun√ß√£o para criar links simb√≥licos
create_symlinks() {
    print_message "$BLUE" "üîó Deseja criar links simb√≥licos em /usr/local/bin? (s/N)"
    read -r create_links
    
    if [[ "$create_links" == "s" || "$create_links" == "S" ]]; then
        print_message "$BLUE" "üîó Criando links simb√≥licos..."
        
        local created_links=0
        local main_scripts=(
            "backup-diretorio.sh"
            "gerenciar-usuarios.sh"
            "pingar.sh"
            "retorna-ip.sh"
            "procurar-arquivo.sh"
            "verifica-usuario-logado.sh"
        )
        
        for script in "${main_scripts[@]}"; do
            if [[ -f "$SCRIPT_DIR/$script" ]]; then
                local link_name="${script%.sh}"
                if sudo ln -sf "$SCRIPT_DIR/$script" "/usr/local/bin/$link_name" 2>/dev/null; then
                    print_message "$GREEN" "‚úÖ Link criado: $link_name"
                    ((created_links++))
                else
                    print_message "$YELLOW" "‚ö†Ô∏è  Falha ao criar link: $link_name"
                fi
            fi
        done
        
        print_message "$GREEN" "‚úÖ Criados $created_links links simb√≥licos"
        print_message "$CYAN" "üí° Agora voc√™ pode executar os scripts de qualquer lugar!"
    fi
}

# Fun√ß√£o para instalar Zenity (interface gr√°fica)
install_zenity() {
    print_message "$BLUE" "üñ•Ô∏è  Deseja instalar Zenity para interfaces gr√°ficas? (s/N)"
    read -r install_zen
    
    if [[ "$install_zen" == "s" || "$install_zen" == "S" ]]; then
        print_message "$BLUE" "üì¶ Instalando Zenity..."
        
        if command -v apt &> /dev/null; then
            sudo apt install -y zenity
        elif command -v dnf &> /dev/null; then
            sudo dnf install -y zenity
        elif command -v yum &> /dev/null; then
            sudo yum install -y zenity
        elif command -v zypper &> /dev/null; then
            sudo zypper install -y zenity
        elif command -v pacman &> /dev/null; then
            sudo pacman -S --noconfirm zenity
        else
            print_message "$YELLOW" "‚ö†Ô∏è  Instale Zenity manualmente para usar interfaces gr√°ficas"
        fi
        
        print_message "$GREEN" "‚úÖ Zenity instalado com sucesso"
    fi
}

# Fun√ß√£o para verificar integridade
verify_installation() {
    print_message "$BLUE" "üîç Verificando integridade da instala√ß√£o..."
    
    local total_scripts=0
    local executable_scripts=0
    
    while IFS= read -r -d '' script; do
        if [[ -f "$script" && "$script" == *.sh ]]; then
            ((total_scripts++))
            if [[ -x "$script" ]]; then
                ((executable_scripts++))
            fi
        fi
    done < <(find "$SCRIPT_DIR" -name "*.sh" -print0)
    
    print_message "$CYAN" "üìä Scripts encontrados: $total_scripts"
    print_message "$CYAN" "üìä Scripts execut√°veis: $executable_scripts"
    
    if [[ $executable_scripts -eq $total_scripts ]]; then
        print_message "$GREEN" "‚úÖ Instala√ß√£o verificada com sucesso!"
    else
        print_message "$YELLOW" "‚ö†Ô∏è  Alguns scripts podem n√£o estar execut√°veis"
    fi
}

# Fun√ß√£o para exibir menu de testes
show_test_menu() {
    print_message "$BLUE" "üß™ Deseja testar alguns scripts? (s/N)"
    read -r run_tests
    
    if [[ "$run_tests" == "s" || "$run_tests" == "S" ]]; then
        echo
        echo -e "${YELLOW}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${YELLOW}‚ïë            MENU DE TESTES             ‚ïë${NC}"
        echo -e "${YELLOW}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo -e "${WHITE}1.${NC} Testar retorna-ip.sh"
        echo -e "${WHITE}2.${NC} Testar verifica-usuario-logado.sh"
        echo -e "${WHITE}3.${NC} Demonstra√ß√£o Zenity (se instalado)"
        echo -e "${WHITE}4.${NC} Jogar Tetris"
        echo -e "${WHITE}5.${NC} Pular testes"
        echo
        
        read -p "Escolha uma op√ß√£o (1-5): " test_choice
        
        case $test_choice in
            1)
                print_message "$BLUE" "üåê Executando teste de IP..."
                if [[ -x "$SCRIPT_DIR/retorna-ip.sh" ]]; then
                    "$SCRIPT_DIR/retorna-ip.sh"
                else
                    print_message "$RED" "‚ùå Script n√£o encontrado ou n√£o execut√°vel"
                fi
                ;;
            2)
                print_message "$BLUE" "üë• Verificando usu√°rios logados..."
                if [[ -x "$SCRIPT_DIR/verifica-usuario-logado.sh" ]]; then
                    "$SCRIPT_DIR/verifica-usuario-logado.sh"
                else
                    print_message "$RED" "‚ùå Script n√£o encontrado ou n√£o execut√°vel"
                fi
                ;;
            3)
                if command -v zenity &> /dev/null; then
                    print_message "$BLUE" "üñ•Ô∏è  Executando demonstra√ß√£o Zenity..."
                    if [[ -x "$SCRIPT_DIR/zenity-demo.sh" ]]; then
                        "$SCRIPT_DIR/zenity-demo.sh"
                    else
                        print_message "$RED" "‚ùå Script n√£o encontrado ou n√£o execut√°vel"
                    fi
                else
                    print_message "$YELLOW" "‚ö†Ô∏è  Zenity n√£o est√° instalado"
                fi
                ;;
            4)
                print_message "$BLUE" "üéÆ Iniciando Tetris..."
                if [[ -x "$SCRIPT_DIR/tetris.sh" ]]; then
                    "$SCRIPT_DIR/tetris.sh"
                else
                    print_message "$RED" "‚ùå Script n√£o encontrado ou n√£o execut√°vel"
                fi
                ;;
            5)
                print_message "$CYAN" "‚è≠Ô∏è  Pulando testes..."
                ;;
            *)
                print_message "$YELLOW" "‚ö†Ô∏è  Op√ß√£o inv√°lida"
                ;;
        esac
    fi
}

# Fun√ß√£o para exibir informa√ß√µes finais
show_final_info() {
    echo
    print_message "$GREEN" "üéâ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!"
    echo
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                              PR√ìXIMOS PASSOS                                 ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    echo -e "${WHITE}üìñ Documenta√ß√£o completa:${NC} cat README.md"
    echo -e "${WHITE}üìÇ Listar todos os scripts:${NC} ls -la *.sh"
    echo -e "${WHITE}üéÆ Jogar Tetris:${NC} ./tetris.sh"
    echo -e "${WHITE}üéÆ Jogar Space Invaders:${NC} ./invaders.sh"
    echo -e "${WHITE}üíæ Fazer backup:${NC} ./backup-diretorio.sh"
    echo -e "${WHITE}üë• Gerenciar usu√°rios:${NC} sudo ./gerenciar-usuarios.sh"
    echo -e "${WHITE}üåê Testar conectividade:${NC} ./pingar.sh google.com cloudflare.com 5"
    echo -e "${WHITE}üîç Buscar arquivos:${NC} ./procurar-arquivo.sh"
    echo -e "${WHITE}üìä Ver IP e rede:${NC} ./retorna-ip.sh"
    echo
    echo -e "${YELLOW}üìã Log da instala√ß√£o salvo em:${NC} $LOG_FILE"
    echo
}

#=============================================================================
# FUN√á√ÉO PRINCIPAL
#=============================================================================

main() {
    print_header
    
    print_message "$BLUE" "üöÄ Iniciando instala√ß√£o da Shell Bash Scripts Collection..."
    echo
    
    # Detectar sistema operacional
    detect_os
    echo
    
    # Verificar e instalar depend√™ncias
    check_dependencies
    echo
    
    # Configurar permiss√µes
    setup_permissions
    echo
    
    # Criar links simb√≥licos (opcional)
    create_symlinks
    echo
    
    # Instalar Zenity (opcional)
    install_zenity
    echo
    
    # Verificar instala√ß√£o
    verify_installation
    echo
    
    # Menu de testes
    show_test_menu
    echo
    
    # Informa√ß√µes finais
    show_final_info
}

#=============================================================================
# EXECU√á√ÉO
#=============================================================================

# Verificar se o script est√° sendo executado como root desnecessariamente
if [[ $EUID -eq 0 ]] && [[ "$1" != "--allow-root" ]]; then
    print_message "$YELLOW" "‚ö†Ô∏è  Este script n√£o precisa ser executado como root."
    print_message "$CYAN" "üí° Execute: ./install.sh"
    print_message "$CYAN" "üí° Ou se necess√°rio: ./install.sh --allow-root"
    exit 1
fi

# Executar fun√ß√£o principal
main "$@"

# C√≥digo de sa√≠da
print_message "$GREEN" "‚úÖ Instala√ß√£o finalizada com sucesso!"
exit 0